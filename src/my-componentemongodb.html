<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<!-- Añadimos compoenente que viene para en linea inferior para sacar array (    <template is="dom-repeat" items="...)-->
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="my-componentemongodb">
  <template>
    <style>
      :host {  /* Para referenciar el estilo de mi componente */
        display: inline-block;
        background-color: yellow; <!-- Indico color de fondo para diferenciar area del compoennte -->
      }
    </style>

    <!-- Metemos parte para interactuar con MongoDB -->
    <div><span>Ahora vamos a interactuar con MongoDB....</span></div>
    <div>
      Titulo:
      <input type="text" name="tituloInput"/>
      <p>
      Texto:
      <input type="text" name="textoInput"/>
      <p>
      Autor:
      <input type="text" name="textoNombre"/><input type="text" name="textoApellido"/>
    </div>

    <div><button type="button" name="btnGrabarPost" on-click="grabarPosts">Añadir post a MongoDB</button></div>
    <p>
    <div><button type="button" name="btnObtenerPosts" on-click="obtenerPosts">Obtener posts MongoDB</button></div>
    <p>
    <div>POSTS...</div>
    <template is="dom-repeat" items="[[posts]]">
      <div>
        <b>Título:</b> [[item.titulo]], <b>Texto:</b> [[item.texto]], <b>Autor:</b> [[item.autor.nombre]] [[item.autor.apellido]]
        <button type="button" name="btnBorrarPosts" on-click="borrarPosts(" + item._id + ")">Borrar post</button>
      </div>
    </template>

  </template>
    <script>
      /* Lo siguiente es porque heredamos del Polymer element. Se podria hacer como en my-view poniendo class...
      class MyView1 extends Polymer.Element {
        static get is() { return 'my-view1'; }
      }
      */
      Polymer({
        is: 'my-componentemongodb',
        properties: {
          url: {
            type: String,
            value: "https://api.mlab.com/api/1/databases/dbbootcamp/collections/posts"
          },
          apiKey: {
            type: String,
            value: "?apiKey=CQjEP7tpIq0_e_u0XbMU2o1Xgt8fgB74"
          },
          posts: {
            type: Array,
            notify: true, //Automáticamente refresca cuando cambia algo...(se supone)
            value: [ { "titulo" : "Nuevo post de JFK" , "texto" : "Texto del post JFK" , "autor" : { "nombre" : "J.F" , "apellido" : "Kennedy"}} , { "titulo" : "Los pilares de la tierra" , "texto" : "Es de Ken Follet" , "autor" : { "nombre" : "Angular" , "apellido" : "Google"}} , { "titulo" : "La Biblia" , "texto" : "Historias" , "autor" : { "nombre" : "Dios" , "apellido" : "Cielo"}} ]
          }
        },
        listeners: {
        },
        grabarPosts: function() {
          var titulo = document.getElementsByName("tituloInput")[0].value;
          var texto = document.getElementsByName("textoInput")[0].value;
          var nombre = document.getElementsByName("textoNombre")[0].value;
          var apellido = document.getElementsByName("textoApellido")[0].value;
          console.log("Titulo: " + titulo + ", Texto: " + texto + ", Nombre: " + nombre + " " + apellido);
          var peticion = new XMLHttpRequest();
          peticion.open("POST", this.url + this.apiKey, true);
          peticion.setRequestHeader("Content-Type", "application/json");
          peticion.send('{"titulo":"' + titulo + '", "texto": "' + texto + '", "autor":{"nombre":"' + nombre + '", "apellido": "' + apellido + '"}}');
        },
        obtenerPosts: function() {
          var peticion = new XMLHttpRequest();
          peticion.open("GET", this.url + this.apiKey, false);
          peticion.setRequestHeader("Content-Type", "application/json");
          peticion.send();
          this.posts = JSON.parse(peticion.responseText);
          sessionStorage["posts"] = peticion.responseText;
          console.log("ROD: " + peticion.responseText);
        },
        borrarPosts: function(id) {
          var peticion = new XMLHttpRequest();
          var URLItem = "https://api.mlab.com/api/1/databases/dbbootcamp/collections/posts/";
          URLItem += id;
          URLItem += this.apiKey;
          console.log("Procedemos a borrar el post con id: " + id);
          peticion.open("DELETE", URLItem, false);
          peticion.setRequestHeader("Content-Type", "application/json");
          peticion.send();
          console.log("El post con id: " + id + " ha sido borrado");
        }
      })
    </script>
</dom-module>
