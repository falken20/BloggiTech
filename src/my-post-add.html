<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<!-- Añadimos compoenente que viene para en linea inferior para sacar array (    <template is="dom-repeat" items="...)-->
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="my-post-add">
  <template>
    <style>
      :host {  /* Para referenciar el estilo de mi componente */
        display: inline-block;
        background-color: white;
        width: -moz-available;
        align-items: center;
      }
      .row{
          margin-top:40px;
      }
    </style>

    <div class="row">
        <div class="col-md-6 col-sm-12 col-lg-6 col-md-offset-3">
        <div class="panel panel-primary">
          <div class="panel-heading">Introduce los datos del post
          </div>
          <div class="panel-body">
            <form name="form_post" action="grabarPosts">
              <div class="form-group">
                <i class="glyphicon glyphicon-user"></i>
                <label for="usuario">Usuario</label>
                <input id="usuario" name="usuario" class="form-control" type="text" disabled="disabled" placeholder="[[userlogado]]">
              </div>
              <div class="form-group">
                <label for="titulo">Título *</label>
                <input id="titulo" name="titulo" class="form-control" type="text" data-validation="required">
                <span id="error_titulo" class="text-danger"></span>
              </div>
              <div class="form-group">
                <label for="texto">Texto *</label>
                <textarea class="form-control" rows="4" id="texto" name="texto"></textarea>
              </div>
              <div class="form-group">
                <i class="glyphicon glyphicon-calendar"></i>
                <label for="fecha">Fecha *</label>
                <input type="date" name="fecha" id="fecha" class="form-control" placeholder="dd/mm/yyyy">
                <span id="error_fecha" class="text-danger"></span>
              </div>
              <div class="form-group">
                <i class="glyphicon glyphicon-tag"></i>
                <label for="labels">Etiquetas</label>
                <input id="labels" name="labels" class="form-control" type="text">
              </div>

              <div class="input-group image-preview">
                <i class="glyphicon glyphicon-picture"></i>
                <label for="labels">Imagen</label>
                <input type="file" name="files" id="files" on-change="previewImage" data-validation="required"/>
                <img name="image" id="image" style="margin-top:10px;max-width:100%;height:auto;border-radius:8px;"/>
              </div>

              <div style="margin-top:30px">
                <span class="input-group-btn">
                 <!-- <button id="submit" type="submit" value="submit" class="btn btn-primary center">Submit</button> -->
                 <button type="button" name="btnGrabarPost" on-click="grabarPosts" class="btn btn-info btn-block login">Grabar post</button>
                </span>
              </div>     
              <input name="mensaje" type="text" style="border:0;background-color:white;font-size:large;font-weight:bold;color:red;text-transform:uppercase;">         
              <div style="margin-top:10px">
                <span class="input-group-btn">
                 <a href="post-list" class="btn btn-info btn-block login" role="button">Revisar Posts</a>
                </span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </template>

    <script>
      Polymer({
        is: 'my-post-add',
        properties: {
          url: {
            type: String,
            value: "https://api.mlab.com/api/1/databases/dbbootcamp/collections/posts"
          },
          apiKey: {
            type: String,
            value: "?apiKey=CQjEP7tpIq0_e_u0XbMU2o1Xgt8fgB74"
          },
          posts: {
            type: Array,
            notify: true, //Automáticamente refresca cuando cambia algo...(se supone)
          },
          userlogado: {
            type: String,
            value: "NoLogado"
          },
          //Propiedades para guardar en Amazon S3
          aws_url: {type: String, value: "http://bucket_posts.s3.amazonaws.com/"},
          aws_access_key: {type: String, value: "AKIAIYNHHZYMZDQLRQ7A"}, //En Amazon Security Credentials
          aws_secret_key: {type: String, value: ""},
          aws_bucket: {type: String, value:"bucket-posts"}
        },
        listeners: {
        },
        ready: function() {
          this.userlogado = sessionStorage.getItem("usuario");
          console.log("ROD: Obtengo el usuario logado " + this.userlogado);          
        },
        previewImage: function() {
          var reader = new FileReader();
          reader.onload = function (e) {
              // get loaded data and render thumbnail.
              document.getElementsByName("image")[0].src = e.target.result;
          };
          // read the image file as a data URL.
          console.log(document.getElementsByName("files")[0].value);
          console.log(document.getElementsByName("image")[0].src);
          reader.readAsDataURL(document.getElementsByName("files")[0].files[0]);
        },
        grabarPosts: function() {
          var titulo = document.getElementsByName("titulo")[0].value;
          var texto = document.getElementsByName("texto")[0].value;
          var fecha = document.getElementsByName("fecha")[0].value;
          var labels = document.getElementsByName("labels")[0].value;
          console.log("ROD: Usuario: " + this.userlogado + " Titulo: " + titulo + ", Texto: " + texto + ", Fecha: " + fecha + ", Labels: " + labels);
          var peticion = new XMLHttpRequest();
          peticion.open("POST", this.url + this.apiKey, true);
          peticion.setRequestHeader("Content-Type", "application/json");
          peticion.send('{"titulo":"' + titulo + '", "texto":"' + texto + '", "nombre":"' + this.userlogado + '", "fecha": "' + fecha + '", "labels": "' + labels + '"}}');
          var respuesta = JSON.parse(peticion.responseText);
          if (peticion.status=="200")
          {
              console.log("Post añadido");
              document.getElementsByName("mensaje")[0].value = "Post grabado correctamente";
          }
          else 
          {
              console.log("Error al grabar el post");
              document.getElementsByName("mensaje")[0].value = "Error al grabar post";
          }         
        }
      })
    </script>
</dom-module>
