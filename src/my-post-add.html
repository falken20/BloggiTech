<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">

<!-- Añadimos compoenente que viene para en linea inferior para sacar array (    <template is="dom-repeat" items="...)-->
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="my-post-add">
  <template>
    <style>
      :host {  /* Para referenciar el estilo de mi componente */
        display: inline-block;
        background-color: white;
        width: -moz-available;
        align-items: center;
      }
      .row{
          margin-top:40px;
      }
    </style>


    <div class="row">
        <div class="col-md-6 col-sm-12 col-lg-6 col-md-offset-3">
        <div class="panel panel-primary">
          <div class="panel-heading">Introduce los datos del post
          </div>
          <div class="panel-body">
            <form name="form_post" action="grabarPosts">
              <div class="form-group">
                <label for="usuario">Usuario</label>
                <input id="usuario" name="usuario" class="form-control" type="text" disabled="disabled" placeholder="[[userlogado]]">
              </div>
              <div class="form-group">
                <label for="titulo">Título *</label>
                <input id="titulo" name="titulo" class="form-control" type="text" data-validation="required">
                <span id="error_titulo" class="text-danger"></span>
              </div>
              <div class="form-group">
                <label for="texto">Texto *</label>
                <textarea class="form-control" rows="4" id="texto" name="texto"></textarea>
              </div>
              <div class="form-group">
                <label for="fecha">Fecha *</label>
                <input type="date" name="fecha" id="fecha" class="form-control" placeholder="dd/mm/yyyy">
                <span id="error_fecha" class="text-danger"></span>
              </div>
              <div class="form-group">
                <label for="labels">Etiquetas</label>
                <input id="labels" name="labels" class="form-control" type="text">
              </div>
              <div class="input-group image-preview">
                <input type="text" class="form-control image-preview-filename" disabled="disabled"> <!-- don't give a name === doesn't send on POST/GET -->
                <span class="input-group-btn">
                    <!-- image-preview-clear button -->
                    <button type="button" class="btn btn-default image-preview-clear" style="display:none;">
                        <span class="glyphicon glyphicon-remove"></span> Clear
                    </button>
                    <!-- image-preview-input -->
                    <div class="btn btn-default image-preview-input">
                        <span class="glyphicon glyphicon-folder-open"></span>
                        <span class="image-preview-input-title">Browse</span>
                        <input type="file" accept="image/png, image/jpeg, image/gif" name="input-file-preview"/> <!-- rename it -->
                    </div>
                </span>
              </div><!-- /input-group image-preview [TO HERE]--> 
              <div style="margin-top:30px">
                <span class="input-group-btn">
                 <!-- <button id="submit" type="submit" value="submit" class="btn btn-primary center">Submit</button> -->
                 <button type="button" name="btnGrabarPost" on-click="grabarPosts" class="btn btn-info btn-block login">Grabar post</button>
                </span>
              </div>              
              <div style="margin-top:10px">
                <span class="input-group-btn">
                 <a href="post-list" class="btn btn-info btn-block login" role="button">Revisar Posts</a>
                </span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </template>

    <script>
      Polymer({
        is: 'my-post-add',
        properties: {
          url: {
            type: String,
            value: "https://api.mlab.com/api/1/databases/dbbootcamp/collections/posts"
          },
          apiKey: {
            type: String,
            value: "?apiKey=CQjEP7tpIq0_e_u0XbMU2o1Xgt8fgB74"
          },
          posts: {
            type: Array,
            notify: true, //Automáticamente refresca cuando cambia algo...(se supone)
          },
          userlogado: {
            type: String,
            value: "NoLogado"
          }
        },
        listeners: {
        },
        ready: function() {
          this.userlogado = sessionStorage.getItem("usuario");
          console.log("ROD: Obtengo el usuario logado " + this.userlogado);          
        },
        grabarPosts: function() {
          var titulo = document.getElementsByName("titulo")[0].value;
          var texto = document.getElementsByName("texto")[0].value;
          var fecha = document.getElementsByName("fecha")[0].value;
          var labels = document.getElementsByName("labels")[0].value;
          console.log("ROD: Usuario: " + this.userlogado + " Titulo: " + titulo + ", Texto: " + texto + ", Fecha: " + fecha + ", Labels: " + labels);
          var peticion = new XMLHttpRequest();
          peticion.open("POST", this.url + this.apiKey, true);
          peticion.setRequestHeader("Content-Type", "application/json");
          peticion.send('{"titulo":"' + titulo + '", "texto":"' + texto + '", "nombre":"' + this.userlogado + '", "fecha": "' + fecha + '", "labels": "' + labels + '"}}');
          var respuesta = JSON.parse(peticion.responseText);
          if (peticion.status=="200")
          {
              console.log("Post añadido");
          }
          else 
          {
              console.log("Error al grabar el post");
              spanMensaje.innerText = "No se pudo crear el usuario";
          }         
        }
      })
    </script>
</dom-module>
